<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>DJ-Style Radial SVG Animator</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background: #111;
      font-family: 'Courier New', monospace;
      color: #0f0;
    }

    #animationContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .monad {
      position: absolute;
      display: block;
      transform-origin: center center;
      pointer-events: none;
    }

    .control-panel {
      top: 10px;
      left: 10px;
      position: fixed;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #0f0;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 0 10px #0f0;
      z-index: 1000;
      width: 240px;
      transition: all 0.3s ease;
      display: none;
      overflow-y: auto;
    }

    .control-panel.active {
      display: block;
    }

    .control-panel.collapsed {
      height: 40px;
      overflow: hidden;
    }

    .control-panel h3 {
      margin: 0 0 8px;
      font-size: 16px;
      text-align: center;
      text-decoration: underline;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .control-panel h3::after {
      content: '‚ñº';
      font-size: 12px;
      transition: transform 0.3s ease;
    }

    .control-panel.collapsed h3::after {
      transform: rotate(-90deg);
    }

    .control-panel label {
      display: block;
      font-size: 12px;
      margin: 6px 0 2px;
    }

    .control-panel input[type="range"],
    .control-panel input[type="number"],
    .control-panel input[type="color"] {
      width: 100%;
    }

    .control-panel input[type="checkbox"] {
      margin-right: 6px;
    }

    .control-panel .small {
      font-size: 11px;
      color: #555;
    }

    .rangeWrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: auto;
      flex: 0;
      padding: 1rem;
      gap: 1.1rem;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .slider-container input[type="range"] {
      flex: 1;
      width: auto;
    }

    .slider-value {
      min-width: 40px;
      text-align: right;
      font-size: 12px;
    }

    input[type=range] {
      display: flex;
      width: 15rem;
      height: 1.5rem;
      -webkit-appearance: none;
      background: linear-gradient(180deg, #8f813d, #706048, #7A702A);
      border-radius: 1.5rem;
      box-shadow: 0 3px 2px -1px rgba(255, 255, 255, 0.25) inset, 0 0 10px 0 rgba(0, 0, 0, 0.5), 0 0 10px 2px rgba(0, 0, 0, 0.25), 0 8px 4px -3px rgba(0, 0, 0, 0.15);
    }

    input[type=range]::-webkit-slider-runnable-track,
    input[type=range]::-moz-range-track {
      background: #222;
      width: 14rem;
      height: 0.25rem;
      border-radius: 3rem;
      cursor: pointer;
      box-shadow: 0 1px 1px 0 rgba(255, 255, 255, 0.25), 0 2px 2px 0 rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(0, 0, 0, 0.25);
    }

    input[type=range]::-webkit-slider-runnable-track {
      background: #222;
      width: 14rem;
      height: 0.25rem;
      margin: 0 0.5rem;
    }

    input[type=range]::-webkit-slider-thumb,
    input[type=range]::-moz-range-thumb {
      width: 1.8rem;
      height: 1.8rem;
      background: radial-gradient(#444 45%, #555 50%, #222 55%, #8C7853 57.5%, #8C7853 100%), conic-gradient(#4b4b4b 10deg, #777 45deg, #5b5b6b 70deg, #9f9f9f 105deg, #444 140deg, #AAA 185deg, #666 210deg, #999 245deg, #777 285deg, #9f9f9f 320deg, #4b4b4b);
      background-blend-mode: overlay;
      box-shadow: 0 0 1px 1px rgba(255, 255, 255, 0.35) inset, 0 1px 1px 1px rgba(255, 255, 255, 0.25) inset, 0 0 2px 2px rgba(0, 0, 0, 0.15) inset, 0 1px 1px 1px rgba(0, 0, 0, 0.35), 0 3px 2px 1px rgba(0, 0, 0, 0.25), 0 6px 4px 3px rgba(0, 0, 0, 0.15);
      border-radius: 1.5rem;
      cursor: pointer;
    }

    input[type=range]::-webkit-slider-thumb {
      transform: translatey(-0.8rem);
      width: 1.8rem;
      height: 1.8rem;
      background: radial-gradient(#444 45%, #555 50%, #222 55%, #8C7853 57.5%, #8C7853 100%), conic-gradient(#4b4b4b 10deg, #777 45deg, #5b5b6b 70deg, #9f9f9f 105deg, #444 140deg, #AAA 185deg, #666 210deg, #999 245deg, #777 285deg, #9f9f9f 320deg, #4b4b4b);
      background-blend-mode: overlay;
      box-shadow: 0 0 1px 1px rgba(255, 255, 255, 0.35) inset, 0 1px 1px 1px rgba(255, 255, 255, 0.25) inset, 0 0 2px 2px rgba(0, 0, 0, 0.15) inset, 0 1px 1px 1px rgba(0, 0, 0, 0.35), 0 3px 2px 1px rgba(0, 0, 0, 0.25), 0 6px 4px 3px rgba(0, 0, 0, 0.15);
      border-radius: 1.5rem;
      cursor: pointer;
      -webkit-appearance: none;
    }

    datalist {
      display: flex;
      justify-content: space-between;
      color: hsl(45, 80%, 35%);
      width: 25rem;
      line-height: 1.75;
      transform: translatey(0.8rem);
    }

    datalist>option {
      z-index: 1;
      display: flex;
      position: relative;
      padding: 0 0.25rem;
      border: 1px solid hsl(45, 80%, 35%);
      border-radius: 0.5rem;
      text-shadow: 0 1px 1px 0 rgba(0, 0, 0, 0.25);
      box-shadow: 0 1px 1px 0 rgba(0, 0, 0, 0.25);
    }

    datalist>option:before {
      content: '';
      display: inline-block;
      position: relative;
      left: 50%;
      height: 1rem;
      width: 1px;
      background: hsl(45, 80%, 35%);
      transform: translatey(-100%);
    }

    .menu-button {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #0f0;
      border-radius: 6px;
      padding: 8px 12px;
      color: #0f0;
      cursor: pointer;
      z-index: 1001;
      font-family: 'Courier New', monospace;
      box-shadow: 0 0 10px #0f0;
    }

    .menu-button:hover {
      background: rgba(0, 255, 0, 0.1);
    }

    .panel-menu {
      position: fixed;
      top: 50px;
      right: 10px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #0f0;
      border-radius: 6px;
      padding: 8px;
      z-index: 1001;
      display: none;
      box-shadow: 0 0 10px #0f0;
    }

    .panel-menu.active {
      display: block;
    }

    .panel-menu-item {
      padding: 8px 12px;
      color: #0f0;
      cursor: pointer;
      border-radius: 4px;
      margin: 2px 0;
      transition: background 0.2s ease;
    }

    .panel-menu-item:hover {
      background: rgba(0, 255, 0, 0.1);
    }

    .panel-menu-item.active {
      background: rgba(0, 255, 0, 0.2);
    }

    .rotation-control {
      margin: 8px 0;
      padding: 8px;
      background: rgba(0, 255, 0, 0.05);
      border-radius: 4px;
    }

    .direction-control {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .direction-control label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .direction-control input[type="radio"] {
      margin: 0;
    }

    .section-divider {
      border: none;
      border-top: 1px solid #0f0;
      margin: 16px 0 8px 0;
      opacity: 0.25;
    }
  </style>
</head>

<body>

  <!-- Animation canvas -->
  <div id="animationContainer"></div>
  <div id="svgContainer" style="display:none;"></div>

  <!-- Menu Button -->
  <div class="menu-button">‚ò∞ Menu</div>
  <div class="panel-menu">
    <div class="panel-menu-item" data-panel="imageAssetControls">üñºÔ∏è Image Asset Controls</div>
    <div class="panel-menu-item" data-panel="radialControls">üéõÔ∏è Animation Controls</div>
    <div class="panel-menu-item" data-panel="filterControls">üé® Appearance Controls</div>
    <div class="panel-menu-item" data-panel="audioControls">üéß Audio Controls</div>
  </div>

  <!-- Image Asset controls -->
  <div id="imageAssetControls" class="control-panel">
    <h3>üñºÔ∏è Image Asset Controls</h3>
    <div class="panel-content">
      <label>Upload SVG or PNG:</label>
      <div id="dropZone"
        style="border:2px dashed #0f0; padding:20px; text-align:center; margin-bottom:10px; cursor:pointer; position:relative;">
        <input type="file" id="svgUpload" accept=".svg,.png"
          style="position:absolute; width:100%; height:100%; top:0; left:0; opacity:0; cursor:pointer;">
        <div id="dropZoneContent" style="pointer-events:none;">
          <div style="margin-bottom:8px;">üìÅ Drag & Drop Here</div>
          <div style="font-size:12px; color:#0f0;">or click to choose file</div>
        </div>
        <div id="fileInfo"
          style="display:none; flex-direction:column; align-items:center; gap:6px; pointer-events:auto;">
          <span id="fileName"
            style="color:#0f0; max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block;"></span>
          <button id="unmountBtn"
            style="background:#222; color:#0f0; border:1px solid #0f0; border-radius:4px; padding:4px 10px; cursor:pointer; margin-top:4px; width:100px;">Unmount</button>
        </div>
      </div>
      <div id="examplesSection" style="margin-top:12px;">
        <label style="font-size:12px; color:#0f0;">Examples:</label>
        <div id="examplesList" style="display:flex; flex-direction:column; gap:6px; margin-top:4px;"></div>
      </div>
    </div>
  </div>

  <!-- Radial / Scale controls -->
  <div id="radialControls" class="control-panel">
    <h3>üéõÔ∏è Animation Controls</h3>
    <div class="panel-content">
      <label>Radial Repeats:</label>
      <div class="slider-container">
        <input type="range" id="repeatCount" min="1" max="64" step="1">
        <span class="slider-value"></span>
      </div>

      <label>Base Size (px):</label>
      <div class="slider-container">
        <input type="range" id="sizeSlider" min="50" max="500">
        <span class="slider-value"></span>
      </div>

      <label>Radius (px):</label>
      <div class="slider-container">
        <input type="range" id="radiusSlider" min="0" max="500">
        <span class="slider-value"></span>
      </div>

      <hr class="section-divider">
      <label>Composite Rotation:</label>
      <div class="rotation-control">
        <div class="direction-control">
          <label><input type="radio" name="compDir" value="ccw" checked> Counter-clockwise</label>
          <label><input type="radio" name="compDir" value="cw"> Clockwise</label>
        </div>
        <div class="slider-container">
          <input type="range" id="compSpeed" min="0" max="0.1" step="0.001" value="0.01">
          <span class="slider-value"></span>
        </div>
      </div>

      <label>Individual Spin:</label>
      <div class="rotation-control">
        <div class="direction-control">
          <label><input type="radio" name="indDir" value="ccw" checked> Counter-clockwise</label>
          <label><input type="radio" name="indDir" value="cw"> Clockwise</label>
        </div>
        <div class="slider-container">
          <input type="range" id="indSpeed" min="0" max="0.2" step="0.001" value="0.03">
          <span class="slider-value"></span>
        </div>
      </div>

      <hr class="section-divider">
      <label><input type="checkbox" id="scaleToggle"> Enable Scale Pulsation</label>
      <label>Scale Rate:</label>
      <div class="slider-container">
        <input type="range" id="scaleRate" min="0" max="0.2" step="0.001">
        <span class="slider-value"></span>
      </div>
      <label>Scale Amount:</label>
      <div class="slider-container">
        <input type="range" id="scaleAmp" min="0" max="1" step="0.01">
        <span class="slider-value"></span>
      </div>
      <label><input type="checkbox" id="perItemScaleToggle"> Individual Scale Variation</label>

      <hr class="section-divider">
      <label><input type="checkbox" id="radialToggle"> Enable Radial Oscillation</label>
      <label>Oscillation Rate:</label>
      <div class="slider-container">
        <input type="range" id="radialRate" min="0" max="0.2" step="0.001">
        <span class="slider-value"></span>
      </div>
      <label>Oscillation Amount (px):</label>
      <div class="slider-container">
        <input type="range" id="radialAmp" min="0" max="200" step="1">
        <span class="slider-value"></span>
      </div>
      <label><input type="checkbox" id="perItemRadialToggle"> Individual Radial Variation</label>

      <button id="radialResetBtn"
        style="width: 100%; margin-top: 10px; padding: 8px; background: #0f0; color: #000; border: none; border-radius: 4px; cursor: pointer; font-family: 'Courier New', monospace;">Reset
        Animation Controls</button>
    </div>
  </div>

  <!-- Appearance controls -->
  <div id="filterControls" class="control-panel">
    <h3>üé® Appearance Controls</h3>
    <div class="panel-content">
      <label><input type="checkbox" id="filterToggle"> Enable Filters</label>

      <label>Background Color:</label>
      <input type="color" id="bgColorPicker" style="width: 100%; margin-bottom: 10px;">

      <label><input type="checkbox" id="hueToggle"> Enable Hue Shift</label>
      <label>Hue Speed:</label>
      <div class="slider-container">
        <input type="range" id="hueSpeed" min="0" max="5" step="0.1">
        <span class="slider-value"></span>
      </div>
      <label>Hue Drift Speed:</label>
      <div class="slider-container">
        <input type="range" id="hueDriftSpeed" min="-2" max="2" step="0.01" value="0.2">
        <span class="slider-value"></span>
      </div>

      <label>Brightness:</label>
      <div class="slider-container">
        <input type="range" id="brightnessFilter" min="0" max="200" value="110" step="1">
        <span class="slider-value"></span>
      </div>

      <label>Contrast:</label>
      <div class="slider-container">
        <input type="range" id="contrastFilter" min="0" max="200" value="120" step="1">
        <span class="slider-value"></span>
      </div>

      <label>Saturation:</label>
      <div class="slider-container">
        <input type="range" id="saturationFilter" min="0" max="200" value="130" step="1">
        <span class="slider-value"></span>
      </div>

      <label>Blur:</label>
      <div class="slider-container">
        <input type="range" id="blurFilter" min="0" max="10" value="0.5" step="0.1">
        <span class="slider-value"></span>
      </div>

      <label>Sepia:</label>
      <div class="slider-container">
        <input type="range" id="sepiaFilter" min="0" max="100" value="15" step="1">
        <span class="slider-value"></span>
      </div>

      <label>Invert:</label>
      <div class="slider-container">
        <input type="range" id="invertFilter" min="0" max="100" value="0" step="1">
        <span class="slider-value"></span>
      </div>

      <label>Grayscale:</label>
      <div class="slider-container">
        <input type="range" id="grayscaleFilter" min="0" max="100" value="0" step="1">
        <span class="slider-value"></span>
      </div>

      <label>Hue Rotate:</label>
      <div class="slider-container">
        <input type="range" id="hueRotateFilter" min="0" max="360" value="45" step="1">
        <span class="slider-value"></span>
      </div>

      <button id="filterResetBtn"
        style="width: 100%; margin-top: 10px; padding: 8px; background: #0f0; color: #000; border: none; border-radius: 4px; cursor: pointer; font-family: 'Courier New', monospace;">Reset
        Appearance Controls</button>
    </div>
  </div>

  <!-- Audio controls -->
  <div id="audioControls" class="control-panel">
    <h3>üéß Audio Controls</h3>
    <div class="panel-content">
      <label><input type="checkbox" id="audioToggle"> Audio Reactive</label>
      <span class="small">(allow mic when prompted)</span>

      <label>Sensitivity:</label>
      <div class="slider-container">
        <input type="range" id="audioSens" min="0" max="5" step="0.1">
        <span class="slider-value"></span>
      </div>

      <label>Bass Boost:</label>
      <div class="slider-container">
        <input type="range" id="bassBoost" min="0" max="5" step="0.1">
        <span class="slider-value"></span>
      </div>

      <label>Mid Boost:</label>
      <div class="slider-container">
        <input type="range" id="midBoost" min="0" max="5" step="0.1">
        <span class="slider-value"></span>
      </div>

      <label>Treble Boost:</label>
      <div class="slider-container">
        <input type="range" id="trebBoost" min="0" max="5" step="0.1">
        <span class="slider-value"></span>
      </div>

      <label>Max Radius Mod (px):</label>
      <div class="slider-container">
        <input type="range" id="audioModMax" min="0" max="500" step="10">
        <span class="slider-value"></span>
      </div>

      <button id="audioResetBtn"
        style="width: 100%; margin-top: 10px; padding: 8px; background: #0f0; color: #000; border: none; border-radius: 4px; cursor: pointer; font-family: 'Courier New', monospace;">Reset
        Audio Controls</button>
    </div>
  </div>

  <script>
    // === Globals & DOM refs ===
    let sourceSvg = null, vbW = 1, vbH = 1;
    let clones = [], compAng = 0, scaleAng = 0, hueAng = 0, radOscAng = 0, running = false;
    let loadedFileName = null;

    const svgUpload = document.getElementById('svgUpload');
    const repeatCountIn = document.getElementById('repeatCount');
    const sizeSlider = document.getElementById('sizeSlider');
    const radiusSlider = document.getElementById('radiusSlider');
    const compSpeedIn = document.getElementById('compSpeed');
    const indSpeedIn = document.getElementById('indSpeed');

    const scaleToggle = document.getElementById('scaleToggle');
    const scaleRateIn = document.getElementById('scaleRate');
    const scaleAmpIn = document.getElementById('scaleAmp');
    const perItemScaleToggle = document.getElementById('perItemScaleToggle');

    const radialToggle = document.getElementById('radialToggle');
    const radialRateIn = document.getElementById('radialRate');
    const radialAmpIn = document.getElementById('radialAmp');

    const bgPicker = document.getElementById('bgColorPicker');
    const hueToggle = document.getElementById('hueToggle');
    const hueSpeedIn = document.getElementById('hueSpeed');
    const hueDriftSpeedIn = document.getElementById('hueDriftSpeed');

    const audioToggle = document.getElementById('audioToggle');
    const audioSensIn = document.getElementById('audioSens');
    const bassBoostIn = document.getElementById('bassBoost');
    const midBoostIn = document.getElementById('midBoost');
    const trebBoostIn = document.getElementById('trebBoost');
    const audioModMaxIn = document.getElementById('audioModMax');

    const animContainer = document.getElementById('animationContainer');
    const svgContainer = document.getElementById('svgContainer');
    const SETTINGS_KEY = 'radialAnimatorSettings';

    // Add filter controls
    const filterToggle = document.getElementById('filterToggle');
    const brightnessFilter = document.getElementById('brightnessFilter');
    const contrastFilter = document.getElementById('contrastFilter');
    const saturationFilter = document.getElementById('saturationFilter');
    const blurFilter = document.getElementById('blurFilter');
    const sepiaFilter = document.getElementById('sepiaFilter');
    const invertFilter = document.getElementById('invertFilter');
    const grayscaleFilter = document.getElementById('grayscaleFilter');
    const hueRotateFilter = document.getElementById('hueRotateFilter');

    // sensible defaults
    const D = {
      repeats: 25,
      size: 151,
      radius: 156,
      compSpeed: 0.015,
      indSpeed: -0.013,
      scaleRate: 0.005,
      scaleAmt: 0.65,
      perItemScale: true,
      scaleToggle: true,
      radialRate: 0.004,
      radialAmt: 96,
      radialToggle: true,
      perItemRadial: false,
      bgColor: '#111111',
      hueMode: true,
      hueSpeed: 0.5,
      hueDriftSpeed: 0.1,
      audioSens: 1,
      bassBoost: 1,
      midBoost: 1,
      trebBoost: 1,
      audioModMax: 100,
      audioReactive: false,
      // Filter defaults
      filterEnabled: true,
      brightness: 110,
      contrast: 120,
      saturation: 130,
      blur: 0.5,
      sepia: 15,
      invert: 0,
      grayscale: 0,
      hueRotate: 45
    };

    function loadSettings() {
      const saved = localStorage.getItem(SETTINGS_KEY);
      if (!saved) return;
      try {
        Object.assign(D, JSON.parse(saved));
      } catch (e) {
        console.warn('Failed to parse saved settings', e);
      }
    }

    function saveSettings() {
      const obj = {
        repeats: +repeatCountIn.value,
        size: +sizeSlider.value,
        radius: +radiusSlider.value,
        compSpeed: +compSpeedIn.value,
        indSpeed: +indSpeedIn.value,
        scaleRate: +scaleRateIn.value,
        scaleAmt: +scaleAmpIn.value,
        perItemScale: perItemScaleToggle.checked,
        scaleToggle: scaleToggle.checked,
        radialRate: +radialRateIn.value,
        radialAmt: +radialAmpIn.value,
        radialToggle: radialToggle.checked,
        perItemRadial: perItemRadialToggle.checked,
        bgColor: bgPicker.value,
        hueMode: hueToggle.checked,
        hueSpeed: +hueSpeedIn.value,
        hueDriftSpeed: +hueDriftSpeedIn.value,
        audioSens: +audioSensIn.value,
        bassBoost: +bassBoostIn.value,
        midBoost: +midBoostIn.value,
        trebBoost: +trebBoostIn.value,
        audioModMax: +audioModMaxIn.value,
        audioReactive: audioToggle.checked,
        filterEnabled: filterToggle.checked,
        brightness: +brightnessFilter.value,
        contrast: +contrastFilter.value,
        saturation: +saturationFilter.value,
        blur: +blurFilter.value,
        sepia: +sepiaFilter.value,
        invert: +invertFilter.value,
        grayscale: +grayscaleFilter.value,
        hueRotate: +hueRotateFilter.value
      };
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(obj));
    }

    // Panel-specific reset functions
    function resetRadialControls() {
      // Reset to defaults without loading from localStorage
      repeatCountIn.value = D.repeats;
      sizeSlider.value = D.size;
      radiusSlider.value = D.radius;
      compSpeedIn.value = D.compSpeed;
      indSpeedIn.value = D.indSpeed;
      scaleRateIn.value = D.scaleRate;
      scaleAmpIn.value = D.scaleAmt;
      perItemScaleToggle.checked = D.perItemScale;
      scaleToggle.checked = D.scaleToggle;
      radialRateIn.value = D.radialRate;
      radialAmpIn.value = D.radialAmt;
      radialToggle.checked = D.radialToggle;
      perItemRadialToggle.checked = D.perItemRadial;
      bgPicker.value = D.bgColor;
      hueToggle.checked = D.hueMode;
      hueSpeedIn.value = D.hueSpeed;
      hueDriftSpeedIn.value = D.hueDriftSpeed;
      document.body.style.background = D.bgColor;
      updateValueDisplays();
      saveSettings(); // Save the reset values
      buildMonads(); // Rebuild clones to reflect repeat count
    }

    function resetFilterControls() {
      // Reset to defaults without loading from localStorage
      filterToggle.checked = D.filterEnabled;
      brightnessFilter.value = D.brightness;
      contrastFilter.value = D.contrast;
      saturationFilter.value = D.saturation;
      blurFilter.value = D.blur;
      sepiaFilter.value = D.sepia;
      invertFilter.value = D.invert;
      grayscaleFilter.value = D.grayscale;
      hueRotateFilter.value = D.hueRotate;
      applyFilters();
      updateValueDisplays();
      saveSettings(); // Save the reset values
    }

    function resetAudioControls() {
      // Reset to defaults without loading from localStorage
      audioToggle.checked = D.audioReactive;
      audioSensIn.value = D.audioSens;
      bassBoostIn.value = D.bassBoost;
      midBoostIn.value = D.midBoost;
      trebBoostIn.value = D.trebBoost;
      audioModMaxIn.value = D.audioModMax;
      updateValueDisplays();
      saveSettings(); // Save the reset values
    }

    function updateValueDisplays() {
      document.querySelectorAll('input[type="range"], input[type="number"]').forEach(input => {
        updateValueDisplay(input);
      });
    }

    // Update setDefaults to use the new reset functions
    function setDefaults() {
      resetRadialControls();
      resetFilterControls();
      resetAudioControls();
    }

    function attachSaveListeners() {
      document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', saveSettings);
        input.addEventListener('change', saveSettings);
      });
    }

    // live background update
    bgPicker.addEventListener('input', e => {
      document.body.style.background = e.target.value;
    });

    // file load handlers
    svgUpload.addEventListener('change', e => {
      const f = e.target.files[0];
      if (f) handleFile(f);
    });
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.style.background = 'rgba(0,255,0,0.2)';
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.background = 'transparent';
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.style.background = 'transparent';
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    function handleFile(f) {
      loadedFileName = f.name;
      const ext = f.name.split('.').pop().toLowerCase();
      const r = new FileReader();
      r.onload = ev => {
        if (ext === 'svg') {
          const doc = new DOMParser().parseFromString(ev.target.result, 'image/svg+xml');
          const svg = doc.querySelector('svg');
          if (!svg) return alert('Invalid SVG!');
          svgContainer.innerHTML = '';
          svgContainer.appendChild(svg);
          sourceSvg = svg;
          const vb = svg.viewBox.baseVal;
          vbW = vb.width || svg.clientWidth;
          vbH = vb.height || svg.clientHeight;
          localStorage.setItem('savedFileType', 'svg');
          localStorage.setItem('savedFileData', ev.target.result);
        } else if (ext === 'png') {
          const img = new Image();
          img.onload = () => {
            svgContainer.innerHTML = '';
            svgContainer.appendChild(img);
            sourceSvg = img;
            vbW = img.naturalWidth || img.width || 100;
            vbH = img.naturalHeight || img.height || 100;
            localStorage.setItem('savedFileType', 'png');
            localStorage.setItem('savedFileData', ev.target.result);
            compAng = scaleAng = hueAng = radOscAng = 0;
            buildMonads();
            if (!running) {
              running = true;
              requestAnimationFrame(animate);
            }
          };
          img.src = ev.target.result;
          img.style.display = 'block';
        } else {
          alert('Unsupported file type!');
          return;
        }
        if (ext === 'svg') {
          compAng = scaleAng = hueAng = radOscAng = 0;
          buildMonads();
          if (!running) {
            running = true;
            requestAnimationFrame(animate);
          }
        }
      };
      if (ext === 'svg') r.readAsText(f);
      else if (ext === 'png') r.readAsDataURL(f);
      else alert('Unsupported file type!');
      updateDropZoneUI();
    }

    function updateDropZoneUI() {
      const dropZoneContent = document.getElementById('dropZoneContent');
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const svgUpload = document.getElementById('svgUpload');
      if (loadedFileName) {
        dropZoneContent.style.display = 'none';
        fileInfo.style.display = 'flex';
        fileName.textContent = loadedFileName;
        svgUpload.style.display = 'none';
      } else {
        dropZoneContent.style.display = 'block';
        fileInfo.style.display = 'none';
        fileName.textContent = '';
        svgUpload.style.display = 'block';
      }
    }

    document.getElementById('unmountBtn').addEventListener('click', function (e) {
      e.stopPropagation();
      svgContainer.innerHTML = '';
      sourceSvg = null;
      loadedFileName = null;
      localStorage.removeItem('savedFileType');
      localStorage.removeItem('savedFileData');
      clones = [];
      animContainer.innerHTML = '';
      updateDropZoneUI();
    });

    function loadSavedFile() {
      const type = localStorage.getItem('savedFileType');
      const data = localStorage.getItem('savedFileData');
      if (!type || !data) {
        // No saved file, load default example
        loadDefaultExample();
        return;
      }
      loadedFileName = 'Loaded from previous session';
      svgContainer.innerHTML = '';
      if (type === 'svg') {
        const doc = new DOMParser().parseFromString(data, 'image/svg+xml');
        const svg = doc.querySelector('svg');
        if (!svg) return;
        svgContainer.appendChild(svg);
        sourceSvg = svg;
        const vb = svg.viewBox.baseVal;
        vbW = vb.width || svg.clientWidth;
        vbH = vb.height || svg.clientHeight;
      } else {
        const img = new Image();
        img.onload = () => {
          svgContainer.appendChild(img);
          sourceSvg = img;
          vbW = img.naturalWidth || img.width || 100;
          vbH = img.naturalHeight || img.height || 100;
          buildMonads();
        };
        img.src = data;
        img.style.display = 'block';
      }
      compAng = scaleAng = hueAng = radOscAng = 0;
      if (type === 'svg') {
        buildMonads();
      }
      if (!running) {
        running = true;
        requestAnimationFrame(animate);
      }
      updateDropZoneUI();
    }

    function loadDefaultExample() {
      const img = new Image();
      img.onload = () => {
        svgContainer.innerHTML = '';
        svgContainer.appendChild(img);
        sourceSvg = img;
        vbW = img.naturalWidth || img.width || 100;
        vbH = img.naturalHeight || img.height || 100;
        loadedFileName = 'blue-dragon.svg';
        buildMonads();
        updateDropZoneUI();
        if (!running) {
          running = true;
          requestAnimationFrame(animate);
        }
      };
      img.src = 'image_assets/blue-dragon.svg';
      img.style.display = 'block';
    }

    repeatCountIn.addEventListener('input', () => {
      if (sourceSvg) buildMonads();
    });

    function buildMonads() {
      if (!sourceSvg) return; // Prevent error if no SVG/PNG loaded
      clones = [];
      animContainer.innerHTML = '';
      const n = parseInt(repeatCountIn.value, 10);
      for (let i = 0; i < n; i++) {
        const c = sourceSvg.cloneNode(true);
        c.removeAttribute('style');
        c.style.display = 'block';
        c.classList.add('monad');
        animContainer.appendChild(c);
        clones.push({ el: c, ang: 0 });
      }
    }

    // audio setup
    let audioCtx, analyser, freqData;
    audioToggle.addEventListener('change', async () => {
      if (audioToggle.checked && !audioCtx) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 2048;
          freqData = new Uint8Array(analyser.frequencyBinCount);
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const src = audioCtx.createMediaStreamSource(stream);
          src.connect(analyser);
        } catch (err) {
          alert('Mic access denied');
          audioToggle.checked = false;
        }
      }
    });

    // main animation loop
    function animate() {
      const baseSize = +sizeSlider.value;
      const baseRad = +radiusSlider.value;
      const compDir = document.querySelector('input[name="compDir"]:checked').value;
      const indDir = document.querySelector('input[name="indDir"]:checked').value;
      const compSpd = +compSpeedIn.value * (compDir === 'ccw' ? -1 : 1);
      const indSpd = +indSpeedIn.value * (indDir === 'ccw' ? -1 : 1);
      const sRate = +scaleRateIn.value;
      const sAmt = +scaleAmpIn.value;
      const rRate = +radialRateIn.value;
      const rAmt = +radialAmpIn.value;
      const bg = bgPicker.value;
      const hueOn = hueToggle.checked;
      const hueDr = +hueDriftSpeedIn.value;

      // audio processing
      let audioLevel = 0;
      if (audioToggle.checked && analyser) {
        analyser.getByteFrequencyData(freqData);
        const len = freqData.length;
        const third = Math.floor(len / 3);
        const bass = freqData.slice(0, third).reduce((a, v) => a + v, 0) / third;
        const mid = freqData.slice(third, 2 * third).reduce((a, v) => a + v, 0) / third;
        const treb = freqData.slice(2 * third).reduce((a, v) => a + v, 0) / (len - 2 * third);
        const totalW = +bassBoostIn.value + +midBoostIn.value + +trebBoostIn.value;
        const weighted = bass * +bassBoostIn.value + mid * +midBoostIn.value + treb * +trebBoostIn.value;
        audioLevel = (weighted / 255 / totalW) * +audioSensIn.value;
      }

      document.body.style.background = bg;
      compAng += compSpd;
      scaleAng += sRate;
      radOscAng += rRate;
      if (hueOn) hueAng = (hueAng + hueDr) % 360;

      const n = clones.length;
      const step = Math.PI * 2 / n;
      clones.forEach((c, i) => {
        // radius with uniform oscillation + audio
        let rad = baseRad + audioLevel * +audioModMaxIn.value;
        if (radialToggle.checked) {
          const perItem = perItemRadialToggle.checked;
          if (perItem) {
            // Golden angle for more even distribution
            const goldenAngle = 2.399963229728653;
            rad += rAmt * Math.sin(radOscAng + i * goldenAngle);
          } else {
            rad += rAmt * Math.sin(radOscAng);
          }
        }
        const ang = i * step + compAng;
        const cx = animContainer.clientWidth / 2;
        const cy = animContainer.clientHeight / 2;
        const x = cx + rad * Math.cos(ang);
        const y = cy + rad * Math.sin(ang);

        c.ang += indSpd;

        // scale pulsation (uniform vs per-item)
        let scale = 1;
        if (scaleToggle.checked) {
          const perItem = perItemScaleToggle.checked;
          if (perItem) {
            scale = 1 + sAmt * Math.sin(scaleAng + i * step);
          } else {
            scale = 1 + sAmt * Math.sin(scaleAng);
          }
        }

        const wpx = baseSize * scale;
        const hpx = baseSize * scale * (vbH / vbW);

        c.el.style.width = wpx + 'px';
        c.el.style.height = hpx + 'px';
        c.el.style.left = (x - wpx / 2) + 'px';
        c.el.style.top = (y - hpx / 2) + 'px';
        c.el.style.transform = `rotate(${c.ang}rad)`;

        if (hueOn) {
          const shift = (hueAng + i * (360 / n)) % 360;
          let brightness = 1, saturation = 1;
          if (scaleToggle.checked) {
            const perItem = perItemScaleToggle.checked;
            const t = perItem
              ? (Math.sin(scaleAng + i * step) + 1) / 2
              : (Math.sin(scaleAng) + 1) / 2;
            brightness = 0.75 + 0.25 * t;
            saturation = 0.75 + 0.5 * t;
          }
          c.el.style.filter = `
            brightness(${brightness})
            saturate(${saturation})
            hue-rotate(${shift}deg)
          `;
        } else {
          c.el.style.filter = '';
        }
      });

      requestAnimationFrame(animate);
    }

    // Add value display updates
    function updateValueDisplay(input) {
      const valueDisplay = input.parentElement.querySelector('.slider-value');
      if (valueDisplay) {
        valueDisplay.textContent = input.value;
      }
    }

    // Update all value displays on load
    document.querySelectorAll('input[type="range"], input[type="number"]').forEach(input => {
      updateValueDisplay(input);
      input.addEventListener('input', () => updateValueDisplay(input));
    });

    // initialize
    setDefaults(); // Set defaults first
    loadSettings(); // Then load any saved settings
    if (!localStorage.getItem('savedFileType')) {
      // Load Takashi as the default example if nothing is saved
      loadExampleAsset('image_assets/takashi.svg', 'Takashi');
    } else {
      loadSavedFile();
    }
    attachSaveListeners();
    requestAnimationFrame(animate);

    // Add reset button event listeners
    document.getElementById('filterResetBtn').addEventListener('click', resetFilterControls);
    document.getElementById('audioResetBtn').addEventListener('click', resetAudioControls);
    document.getElementById('radialResetBtn').addEventListener('click', resetRadialControls);

    function applyFilters() {
      if (!filterToggle.checked) {
        animContainer.style.filter = '';
        return;
      }

      const filters = [
        `brightness(${brightnessFilter.value}%)`,
        `contrast(${contrastFilter.value}%)`,
        `saturate(${saturationFilter.value}%)`,
        `blur(${blurFilter.value}px)`,
        `sepia(${sepiaFilter.value}%)`,
        `invert(${invertFilter.value}%)`,
        `grayscale(${grayscaleFilter.value}%)`,
        `hue-rotate(${hueRotateFilter.value}deg)`
      ].join(' ');

      animContainer.style.filter = filters;
    }

    // Add filter event listeners
    filterToggle.addEventListener('change', applyFilters);
    brightnessFilter.addEventListener('input', applyFilters);
    contrastFilter.addEventListener('input', applyFilters);
    saturationFilter.addEventListener('input', applyFilters);
    blurFilter.addEventListener('input', applyFilters);
    sepiaFilter.addEventListener('input', applyFilters);
    invertFilter.addEventListener('input', applyFilters);
    grayscaleFilter.addEventListener('input', applyFilters);
    hueRotateFilter.addEventListener('input', applyFilters);

    // Add panel collapse functionality
    document.querySelectorAll('.control-panel h3').forEach(header => {
      header.addEventListener('click', (e) => {
        // Only toggle collapse if clicking the header directly (not the arrow)
        if (e.target === header || e.target === header.querySelector('::after')) {
          const panel = header.closest('.control-panel');
          panel.classList.toggle('collapsed');
        }
      });
    });

    // Initialize panels as expanded
    document.querySelectorAll('.control-panel').forEach(panel => {
      panel.classList.remove('collapsed');
    });

    // Add panel menu functionality
    const menuButton = document.querySelector('.menu-button');
    const panelMenu = document.querySelector('.panel-menu');
    const menuItems = document.querySelectorAll('.panel-menu-item');
    const panels = document.querySelectorAll('.control-panel');

    menuButton.addEventListener('click', () => {
      panelMenu.classList.toggle('active');
    });

    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        const panelId = item.dataset.panel;

        // Update menu items
        menuItems.forEach(mi => mi.classList.remove('active'));
        item.classList.add('active');

        // Update panels
        panels.forEach(panel => {
          panel.classList.remove('active');
          if (panel.id === panelId) {
            panel.classList.add('active');
          }
        });

        // Hide menu
        panelMenu.classList.remove('active');
      });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!menuButton.contains(e.target) && !panelMenu.contains(e.target)) {
        panelMenu.classList.remove('active');
      }
    });

    // Set initial active panel
    menuItems[0].classList.add('active');

    function updateRotation() {
      const compDir = document.querySelector('input[name="compDir"]:checked').value;
      const indDir = document.querySelector('input[name="indDir"]:checked').value;
      const compSpeed = parseFloat(document.getElementById('compSpeed').value);
      const indSpeed = parseFloat(document.getElementById('indSpeed').value);

      // Update composite rotation
      if (compDir === 'none') {
        compositeRotation = 0;
      } else {
        compositeRotation = compDir === 'ccw' ? compSpeed : -compSpeed;
      }

      // Update individual spin
      if (indDir === 'none') {
        individualSpin = 0;
      } else {
        individualSpin = indDir === 'ccw' ? indSpeed : -indSpeed;
      }

      updateSliderValues();
    }

    function updateSliderValues() {
      const sliders = document.querySelectorAll('.slider-container');
      sliders.forEach(container => {
        const slider = container.querySelector('input[type="range"]');
        const display = container.querySelector('.slider-value');
        if (slider.id === 'radiusSlider') {
          display.textContent = slider.value + 'px';
        } else if (slider.id === 'compSpeed' || slider.id === 'indSpeed') {
          display.textContent = slider.value;
        }
      });
    }

    // Event listeners
    document.querySelectorAll('input[type="range"]').forEach(slider => {
      slider.addEventListener('input', () => {
        if (slider.id === 'radiusSlider') {
          radius = parseFloat(slider.value);
        } else {
          updateRotation();
        }
        updateSliderValues();
      });
    });

    document.querySelectorAll('input[name="compDir"], input[name="indDir"]').forEach(radio => {
      radio.addEventListener('change', updateRotation);
    });

    document.getElementById('scaleToggle').addEventListener('change', function () {
      enableScalePulsation = this.checked;
    });

    // Initialize slider values
    updateSliderValues();

    // Example asset loader
    document.querySelectorAll('.example-btn').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        const filename = btn.getAttribute('data-example');
        if (filename.endsWith('.svg')) {
          fetch(`image_assets/${filename}`)
            .then(res => res.text())
            .then(svgText => {
              const doc = new DOMParser().parseFromString(svgText, 'image/svg+xml');
              const svg = doc.querySelector('svg');
              if (!svg) return alert('Invalid SVG!');
              svgContainer.innerHTML = '';
              svgContainer.appendChild(svg);
              sourceSvg = svg;
              const vb = svg.viewBox.baseVal;
              vbW = vb.width || svg.clientWidth;
              vbH = vb.height || svg.clientHeight;
              loadedFileName = filename;
              compAng = scaleAng = hueAng = radOscAng = 0;
              buildMonads();
              updateDropZoneUI();
              if (!running) {
                running = true;
                requestAnimationFrame(animate);
              }
            });
        } else {
          const img = new Image();
          img.onload = () => {
            svgContainer.innerHTML = '';
            svgContainer.appendChild(img);
            sourceSvg = img;
            vbW = img.naturalWidth || img.width || 100;
            vbH = img.naturalHeight || img.height || 100;
            loadedFileName = filename;
            compAng = scaleAng = hueAng = radOscAng = 0;
            buildMonads();
            updateDropZoneUI();
            if (!running) {
              running = true;
              requestAnimationFrame(animate);
            }
          };
          img.src = `image_assets/${filename}`;
          img.style.display = 'block';
        }
        // Clear localStorage so example is not persisted
        localStorage.removeItem('savedFileType');
        localStorage.removeItem('savedFileData');
      });
    });

    function loadExampleAsset(filename, label) {
      const ext = filename.split('.').pop().toLowerCase();
      loadedFileName = label;
      // Example-specific presets
      const examplePresets = {
        'Takashi': {
          repeats: 64,
          size: 340,
          radius: 108,
          compSpeed: 0.015,
          indSpeed: 0,
          scaleToggle: true,
          scaleRate: 0.005,
          scaleAmt: 0.65,
          perItemScale: true,
          radialToggle: true,
          radialRate: 0.004,
          radialAmt: 96,
          perItemRadial: false,
          bgColor: '#111111',
          hueMode: true,
          hueSpeed: 0.5,
          hueDriftSpeed: 0.1
        }
        // Add more presets for other examples if desired
      };
      const preset = examplePresets[label] || D;
      // Apply preset to controls
      repeatCountIn.value = preset.repeats;
      sizeSlider.value = preset.size;
      radiusSlider.value = preset.radius;
      compSpeedIn.value = preset.compSpeed;
      indSpeedIn.value = preset.indSpeed;
      scaleToggle.checked = preset.scaleToggle;
      scaleRateIn.value = preset.scaleRate;
      scaleAmpIn.value = preset.scaleAmt;
      perItemScaleToggle.checked = preset.perItemScale;
      radialToggle.checked = preset.radialToggle;
      radialRateIn.value = preset.radialRate;
      radialAmpIn.value = preset.radialAmt;
      perItemRadialToggle.checked = preset.perItemRadial;
      bgPicker.value = preset.bgColor;
      hueToggle.checked = preset.hueMode;
      hueSpeedIn.value = preset.hueSpeed;
      hueDriftSpeedIn.value = preset.hueDriftSpeed;
      document.body.style.background = preset.bgColor;
      updateValueDisplays();
      saveSettings();
      // Now load the asset
      if (ext === 'svg') {
        fetch(filename)
          .then(res => res.text())
          .then(data => {
            const doc = new DOMParser().parseFromString(data, 'image/svg+xml');
            const svg = doc.querySelector('svg');
            if (!svg) return alert('Invalid SVG!');
            svgContainer.innerHTML = '';
            svgContainer.appendChild(svg);
            sourceSvg = svg;
            const vb = svg.viewBox.baseVal;
            vbW = vb.width || svg.clientWidth;
            vbH = vb.height || svg.clientHeight;
            localStorage.setItem('savedFileType', 'svg');
            localStorage.setItem('savedFileData', data);
            compAng = scaleAng = hueAng = radOscAng = 0;
            buildMonads();
            if (!running) {
              running = true;
              requestAnimationFrame(animate);
            }
            updateDropZoneUI();
          });
      } else if (ext === 'png') {
        const img = new Image();
        img.onload = () => {
          svgContainer.innerHTML = '';
          svgContainer.appendChild(img);
          sourceSvg = img;
          vbW = img.naturalWidth || img.width || 100;
          vbH = img.naturalHeight || img.height || 100;
          localStorage.setItem('savedFileType', 'png');
          localStorage.setItem('savedFileData', img.src);
          compAng = scaleAng = hueAng = radOscAng = 0;
          buildMonads();
          if (!running) {
            running = true;
            requestAnimationFrame(animate);
          }
          updateDropZoneUI();
        };
        img.src = filename;
      }
    }

    // Populate examples
    function populateExamples() {
      const examples = [
        { file: 'image_assets/blue-dragon.svg', label: 'Blue Dragon' },
        { file: 'image_assets/rubber-duck.png', label: 'Rubber Duck' },
        { file: 'image_assets/takashi.svg', label: 'Takashi' }
      ];
      const examplesList = document.getElementById('examplesList');
      examplesList.innerHTML = '';
      examples.forEach(ex => {
        const btn = document.createElement('button');
        btn.textContent = ex.label;
        btn.style.cssText = 'background:#222; color:#0f0; border:1px solid #0f0; border-radius:4px; padding:4px 10px; cursor:pointer; width:140px; margin-bottom:2px;';
        btn.addEventListener('click', () => loadExampleAsset(ex.file, ex.label));
        examplesList.appendChild(btn);
      });
    }
    populateExamples();
  </script>
</body>

</html>